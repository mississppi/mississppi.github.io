---
title: "Cookieによるセッション管理"
slug: "cookie-session"
order: 4
source: "Real World HTTP"
---

## セッションとは？

HTTPは**ステートレス（状態を持たない）**な通信です。  
つまり、ユーザーがログインしても次のリクエストには「誰か」が伝わらない。

そこで必要になるのが **セッション管理**です。  
セッションでは「一時的なユーザー状態」をサーバー側に保持し、  
クライアントにはその「鍵」となる識別子（セッションID）だけを渡します。

---

## セッションの一般的な流れ

### クライアント（ブラウザ）の役割

- ログイン成功後にサーバーから `Set-Cookie` で送られるセッションIDを保存する
- 以後のリクエストで `Cookie` ヘッダーにセッションIDを自動送信する

### サーバーの役割

- セッションIDを生成（ランダム文字列など）
- サーバー内にセッション情報を保存（RedisやDB）
- セッションIDを `Set-Cookie` でクライアントへ返す
- 各リクエストでセッションIDを照合し、ユーザー状態を復元

---

## 例：初回ログイン時

```
POST /login

→ レスポンス:
Set-Cookie: session_id=abc123; HttpOnly; Secure
```

次のリクエスト以降：

```
GET /dashboard
Cookie: session_id=abc123
```

---

## セッション管理のパターン2種

| 種類 | 特徴 |
|------|------|
| サーバーサイドセッション | サーバーにユーザー状態を保存する方式。セッションIDだけをクッキーでやり取り。 |
| クライアントサイドセッション（署名付きクッキー） | セッション情報自体をCookieに持たせる方式。署名を付けて改ざんを防ぐ。 |

---

## 署名付きクッキーとは？

クライアントに「セッションデータ自体」を渡す方式です。  
セキュリティのために、**署名（HMACなど）を付けて改ざんを防止**します。

### 例

```http
Set-Cookie: session=eyJ1c2VyIjoiYWRtaW4ifQ==.signature
```

- `eyJ1c2VyIjoiYWRtaW4ifQ==` → Base64エンコードしたJSON（ユーザー情報など）
- `.signature` → サーバーの秘密鍵でHMAC署名した値

### メリット

- サーバー側でセッション状態を保存しなくて済む（スケーラブル）

### デメリット

- クッキーサイズ制限に引っかかる可能性（4KB程度）
- クッキーが漏れると情報も一緒に漏れる

---

## 実務での使い分け

| ケース | 選ばれやすい方式 |
|--------|------------------|
| セッションデータが大きい | サーバーサイド方式（例：Redisなど） |
| サーバーに状態を持ちたくない | 署名付きクッキー方式（JWTなど） |

---

## 補足：セキュリティ対策

- `HttpOnly`, `Secure`, `SameSite` 属性を正しく設定
- セッションIDの推測が困難なようにランダム生成
- 署名付きクッキーの場合、秘密鍵の安全な管理が必須
