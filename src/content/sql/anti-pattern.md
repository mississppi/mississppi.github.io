---
title: "アンチパターンまとめ"
slug: "anti-pattern"
order: 3
source: "sql"
---

# 1. ジェイウォーク

## アンチパターン: ひとつのカラムにカンマ区切りで複数入れてしまう

やりたいこと: 多対 1 の関連を作りたい。例) 製品、アカウント
解決策: 交差テーブルを作る。

# 2. ナイーブツリー

## アンチパターン: 常に親の ID のみに依存する

やりたいこと: 階層構造を格納したい。クエリを実行する
解決策: 複数ある

・経路モデル

| comment_id | path | 発言者 |
| ---------- | ---- | ------ |
| 1          | 1/   | aa     |
| 2          | 1/2/ | bb     |

・入れ子集合モデル

lft（左値）と rgt（右値）を使う。
ツリーを**深さ優先探索（Depth-First Search）**で走査。
ノードを順番に基づいて値を割り当て。

| comment_id | path | 発言者 |
| ---------- | ---- | ------ |
| 書類       | 1    | 12     |
| 企画書     | 2    | 7      |
| 企画書 A   | 3    | 4      |
| 企画書 B   | 5    | 6      |
| 報告書     | 8    | 11     |
| 月次報告書 | 9    | 10     |

・閉包モデル

テーブルを 2 つ使う。

メインテーブル:
閉包テーブル:

# 3. ID リクワイアド

## アンチパターン: 全部のテーブルに自動採番の ID を割り振ること。脳死

解決策: ナチュラルキーの採用

# 4. キーレスエントリ

##　アンチパターン: 外部キー制約を使わない

やりたいこと: 簡単にテーブルを作りたい
解決策: 外部キー制約を使う。サロゲートキー

# 5. EAV

# 6. プロミスキャス・アソシエーション

やりたいこと: 複数の親テーブルを参照する
アンチパターン: 外部キーを宣言しない。複数に紐付けられる
解決策：複数外部キーの使用、共通の親テーブルを作成するなど

# 7. マルチカラムアトリビュート

やりたいこと：同じカテゴリに属するデータを複数個格納したい場合。  
例) users テーブルに phone カラムが 3 つある(自宅、携帯、FAX)
解決策: 従属テーブルを作成する。user_phone_numbers

# 9. フロートデータ型をしようする

やりたいこと: 正確な数値の格納をしたい
アンチパターン:FLOAT 型を使う。
解決策: NUMELIC を使う

# 10. サーティーワンフレーバー

やりたいこと: ENUM をつかってデータ格納したい
アンチパターン: 限定してしまう
解決策: 参照テーブルを作成

# 11. ファントムファイル

やりたいこと: 画像などメディア系を扱いたい
アンチパターン: 脳死で S3 とかを使う
解決策: BLOB で保存するか、外部参照するか。物議。

# 12. インデックスショットガン

# 13. ふぃあおぶじあんのうん

やりたいこと:
アンチパターン: NULL に対してクエリを書く。NULL を一般値として扱う。結果 NULL が帰ってきてしまう
解決策: NOTNULL.

# 14. アンビギュアス・グループ

# 15. ランダムセレクション

やりたいこと: ランダムに選ぶ
アンチパターン: 全テーブルスキャンする
解決策: offset を利用する。

# 16. プアマンズサーチエンジン

アンチパターン: like 検索する
解決策: 全文検索を使う

# 17. スパゲッティクエリ

アンチパターン: 一目でわからないクエリ
解決策: with 句とか使って分解する

# 18. インプリシットカラム

アンチパターン: insert のときにカラム名を省略する
解決策: ちゃんと書く

# 19. リーダブルパスワード

# 20. SQL インジェクション

# 21. シュードキー・ニートフリーク

アンチパターン: id の欠番を埋めようとする
解決策: 埋めない

# 2.. シーノーエビル

アンチパターン: 肝心な部分を見落とす。DBAPI を見てない。アプリの SQL しか見てない
解決策: 一時変数とか使ってクエリを構築してから API に渡す

# 24. マジックビーンズ

# 25. 砂の城
